{% extends "base.html" %}
{% block title %}Group Management{% endblock %}
{% block content %}

<div class="Pagecontent">
<div id="Pagebox" class="content box">
    <div style="margin-top:15px;display:flex;justify-content:center;">
        <h1 class="pageheader">Group Management</h1>
    </div>

    <button id="filter_button" class="btn btn-primary mb" class="fa fa-external-link"
                style="margin-left: 0.5vw; margin-bottom: 0.3vw;" onclick="toggleContent()"><i class="fa fa-filter" style="font-size: 1.2em"></i> Filters
    </button>
    <div class="container" style="min-height: 10vw;display: none ;margin-bottom: 1.2vw;" id="filter">
            <div style="margin-top: 20px; margin-left: 20px;">
                <!-- Search Form -->
                <form method="GET" action="{{ url_for('GroupManagement_route.GroupManagement',subpath=action) }}"
                      class="form-inline mb-3 ">
                    <div class="form-row col-md-12">
                        {%if userdetails.Role == 'Admin'%}
                            <div class="form-group col-md-2" style="display:none">

                            <div class="  pl-0">
                                <label for="search_bankid" class="font-weight-bold text-left">Bank:</label>
                            </div>
                            <div class="col-12 pl-0">
                                <select id="search_bankid" name="search_bankid" class="form-control form-control-md"
                                        style="width: 100%;">
                                    <option value="">All</option>
                                    {% for option in bankname %}
                                    <option value="{{ option[0] }}" >{{option[1]}}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        {%endif%}
                        <div class="form-group col-md-2">
                            <div class="  pl-0">
                                <label for="search_groupname" class="font-weight-bold text-left">Group Name:</label>
                            </div>
                            <div class="col-12 pl-0">
                                <input type="text" maxlength="30" oninput="this.value = this.value.replace(/[^a-zA-Z0-9_.]/g, '')" id="search_groupname" name="search_groupname" class="form-control form-control-md"
                                       style="width: 100%;" value="{{ request.args.get('search_groupname', '') }}">
                            </div>
                        </div>

                        <div class="form-group col-md-2">
                            <div class=" pl-0">
                                <label for="search_status" class="font-weight-bold text-left">Status :</label>
                            </div>
                            <div class="col-12 pl-0">

                                <select id="search_status" name="search_status" class="form-control form-control-md"
                                        style="width: 100%;">
                                    <option value="">All</option>
                                    <option value="Active">Active</option>
                                    <option value="Inactive">Inactive</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group col-md-2 align-self-end" style="margin-bottom: 4px">
                            <div class=" pl-0">
                                <button type="submit" class="btn btn-primary btn-md">Search</button>
                            </div>
                        </div>
                    </div>

                </form>
            </div>
    </div>
    <div class="container">


        <div class="GroupTable">
        <div
            class="Tabletop"
            style="display: flex; justify-content: space-between; align-items: center;
            {% if userdetails.Role == 'Checker' %} margin-left: 64%; {% endif %}">
            <!-- Your content goes here -->


                    {% if userdetails.Role == 'Maker' or userdetails.Role == 'Admin' %}
                    <button id="add-group-button" class="btn btn-primary mb-3">+Add Details</button>
                    {%else%}
                    <button style="display:None;" id="add-group-button" class="btn btn-primary mb-3">+Add Details</button>
                    {% endif %}
                    <div class="btn-group" style="display: flex; gap: 0.8vw; ">
                        <div style="display: flex; justify-content: flex-end; padding: 10px;">
                  <div style="position: relative; width: 200px;margin-top: 0.4vw;">
                        <input type="text" id="search-input" placeholder="Search" class="form-control" style="width: 100%; padding-left: 30px;">
                        <i class="fa fa-search" style="position: absolute; top: 50%; left: 10px; transform: translateY(-50%); color: gray;"></i>
                 </div>

                </div>
                            <button id="approve-button" class="btn btn-success mb"
                                    style="font-size: 0.9vw;margin: 1vw 0vw 1vw 0vw;">Approved
                            </button>
                            <button id="pending-button" class="btn btn-warning mb"
                                    style="font-size: 0.9vw;    margin: 1vw 0vw 1vw 0vw;">Pending
                            </button>
                            <button id="decline-button" class="btn btn-danger mb"
                                    style="font-size: 0.9vw;    margin: 1vw 0vw 1vw 0vw;">Declined
                            </button>
                    </div>
                </div>
            </div>
            <table class="table" id="advancedTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th style="max-width:8vw; display:none;">Bank</th>
                        <th>Group Name</th>
                        <th style="max-width:6vw;">Status</th>
                        {% if userdetails.Role in ['Admin', 'Maker'] %}
                             <th>Action</th>
                        {% else %}
                            {% if action in ['pending' ,'declined'] %}
                                <th>Action</th>
                            {% endif %}
                        {% endif %}
                    </tr>
                </thead>

                        <tbody class="page" id="page" >
                             <tr id="new-group-row" style="display: none;">
                        <td>ID</td>
                        {% if userdetails.Role == 'Admin'%}
                        <td style="max-width:8vw;display:none;">
                            <select class="form-control" name="new-bank" id="bankSelect">
                                <option value="" disabled selected>Select an option</option>
                                {% for option in bankname %}
                                    <option value="{{ option[0] }}">{{ option[1] }}</option>
                                {% endfor %}
                            </select>
                        </td>

                        {%else%}
                        <td style="display:none">
                            <span>{{userdetails.BankName}}</span>
                        <input type="hidden" class="form-control" id="bankSelect" name="new-bank" placeholder="Bank"  value="{{userdetails.bankid}}" >
                        </td>
                        {%endif%}

					<td style="width:18vw;">
                    <input type="text" class="form-control" name="new-groupname" id="groupname" placeholder="Enter Group Name" maxlength="90"  oninput="this.value = this.value.replace(/[^a-zA-Z0-9]/g, '')" required>
                    </td>

                        <td style="max-width:6vw;">
                            <select class="form-control" name="new-status" id="statusSelect" required>
                                <option value="Active">Active</option>
                                <option value="Inactive">Inactive</option>
                            </select>
                        </td>
                                  <td>
                                 {% if userdetails.Role == 'Maker' or userdetails.Role == 'Admin' or action == 'declined' or action == 'pending'%}
                                        <div style="display:flex;">
                                        <button type="button" class="btn btn-primary add-group-btn">Add Details</button>
                                        <button type="button" class="btn btn-danger fas fa-times" onclick="location.reload()" style="margin-left: 5px"></button>
                                        </div>
                                    </td>
                                 {%endif%}
                    </tr>
                            {% for group in Groups %}
                                <tr class="frow" id="Group-{{ group.id }}">
                                    <td>{{ loop.index }}</td>
                                    {% if userdetails.Role == 'Admin'%}
                                    <td style="max-width:8vw;display:none;"><span class="groups-value">{{ bank_dict[group.bankid] if group.bankid in bank_dict else '' }}</span><input type="text" class="form-control groups-edit" style="display: none;"></td>
                                    {%else%}
                                    <td style="max-width:8vw;display:none;"><span class="bank-value">{{ bank_dict[group.bankid] if group.bankid in bank_dict else '' }}</span></td>
                                    {%endif%}

                                    <td><span class="GroupName-value">{{ group.GroupName }}</span><input type="text" oninput="this.value = this.value.replace(/[^a-zA-Z0-9_.]/g, '')" class="form-control groupname-edit" style="display: none;" id="groupnameeditInput-{{ group.id }}"></td>


                                    <td style="max-width:6vw;"><span class="Status-value">{{ group.Status }}</span>
                                        <select class="form-control status-edit" style="display: none;" required>
                                            <option value="Active">Active</option>
                                            <option value="Inactive">Inactive</option>
                                        </select>

                                    </td>
                                    {% if action == 'pending'%}
                                        <td>
                                            <div class="button-container">
                                                {% if userdetails.Role == 'Checker' or userdetails.Role == 'Admin' %}
                                                {% set action_route = '/Group_Management_module/GroupManagement/update/' %}
                                                {% set button_label = 'Approve' %}

                                                {% if group.reservedfield1 is not none %}
                                                    {% if 'toggle' in group.reservedfield1 %}
                                                        {% set action_route = '/Group_Management_module/GroupManagement/toggle/' %}
                                                        {% set button_label = 'Toggle' %}
                                                    {% elif 'delete' in group.reservedfield1 %}
                                                        {% set action_route = '/Group_Management_module/GroupManagement/delete/' %}
                                                        {% set button_label = 'Delete' %}
                                                    {% endif %}
                                                {% endif %}

                                                <form action="{{ action_route }}{{ group.id }}" method="post"
                                                      onsubmit="return confirm('Are you sure you want to Approve this group? \nPlease Validate Before Approving') ? (alert('The group has been successfully {{button_label}}!'), true) : false;">
                                                    <input type="hidden" name="action" value="approved">
                                                    <input type="hidden" name="username" value="{{ user }}">
                                                    <button type="submit" class="btn btn-success" style="font-size: 0.9em; display: flex; align-items: center;">
                                                        <i class="fa fa-check" style="margin-right:0.3vw;"></i>{{ button_label }}
                                                    </button>
                                                </form>


                                                    <form action="/Group_Management_module/GroupManagement/update/{{ group.id }}  "method="post" id="combruleid{{group.id}}"
                                                          onsubmit="return confirmSubmission('Are you sure you want to Decline this Group?');">

                                                        <input type="hidden" name="action" value="declined">
                                                        <input type="hidden" name="username" value="{{ user }}">
                                                        <button type="submit" class="btn btn-danger" style="font-size: 0.9em; display: flex; align-items: center;">
                                                           <i class="fa fa-times" style="margin-right: 0.3vw;"></i>
                                                              Decline
                                                        </button>
                                                    </form>
                                                {% else %}
                                                    <form action="/Group_Management_module/GroupManagement/update/{{ group.id }}" method="post"
                                                          onsubmit="return confirmSubmission('Are you sure you want to Alert this Group?');" >
                                                        <input type="hidden" name="action" value="alert">
                                                        <input type="hidden" name="username" value="{{ user }}">
                                                        <button type="submit" class="btn btn-warning" style="font-size: 0.9em;">
                                                            <i class="fa fa fa-bell"></i> Alert
                                                        </button>
                                                    </form>
                                                    <form action="/Group_Management_module/GroupManagement/delete/{{ group.id }}" method="post"
                                                          onsubmit="return confirmSubmission('Are you sure you want to delete this Group?');">
                                                        <input type="hidden" name="username" value="{{ user }}">
                                                        <input type="hidden" name="action" value="pending">
                                                        <button type="submit" class="btn btn-danger fas fa-trash-alt"></button>
                                                    </form>
                                                {% endif %}
                                            </div>
                                        </td>
                                    {% elif action == 'declined' %}
                                        <td>

                                            <div class="button-container">
                                                {% if userdetails.Role == 'Checker' or userdetails.Role == 'Maker' %}
                                                    <span class="text-danger">
                                                             <i class="fas fa-exclamation-circle"></i>  Declined
                                                     </span>
                                                {% else %}
                                                    <button type="button" class="btn btn-primary edit-btn fas fa-edit"></button>
                                                    <button type="button" class="btn btn-success update-btn " style="display: none;"
                                                            id="reupdate"
                                                    onsubmit="return confirmSubmission('Are you sure you want to Update this Group?');">
                                                        <div style="display:flex">
                                                            <i class="fas fa-sync-alt" style="padding-top: 3px;  padding-right: 3px;"></i>
                                                            <a> Update</a></div>
                                                    </button>
                                                    <form action="/Group_Management_module/GroupManagement/update/{{ group.id }}" method="post">
                                                        <input type="hidden" name="action" value="RequestAgain">
                                                        <input type="hidden" name="username" value="{{ user }}">
                                                        <button type="submit" class="btn btn-success "
                                                                style="font-size: 0.8em !important;font-family: sans-serif;">Resend
                                                        </button>
                                                    </form>
                                                    <form action="/Group_Management_module/GroupManagement/delete/{{ group.id }}" method="post">
                                                        <input type="hidden" name="username" value="{{ user }}">
                                                        <input type="hidden" name="action" value="declined">
                                                        <button type="submit" class="btn btn-danger fas fa-trash-alt"></button>
                                                    </form>
                                                {% endif %}

                                            </div>

                                        </td>
                                    {% else %}
                                        {% if userdetails.Role == 'Maker' or userdetails.Role == 'Admin' %}
                                            <td>
                                                <div class="button-container">
                                                <!-- Edit Button with tooltip if disabled -->
                                                <button type="button" class="btn btn-primary edit-btn fas fa-edit"
                                                    {% if 'Pendingupdation' in group.isid %} disabled title="It is already present in pending tab for changes" {% endif %}>
                                                </button>

                                                <button type="button" class="btn btn-success update-btn " style="display: none;"><i class="fas fa-sync-alt" style="margin-right:5px;"></i>Update</button>

                                                <form action="/Group_Management_module/GroupManagement/toggle/{{ group.id }}" method="post">
                                                    <input type="hidden" name="username" value="{{ user }}">
                                                    <!-- Toggle Button with tooltip if disabled -->
                                                    <button type="submit"
                                                            class="btn toggle-group-btn btn-{{ 'success fas fa-check' if group.Status == 'Inactive' else 'warning fas fa-times' }}"
                                                            {% if 'Pendingtoggle' in group.isid %} disabled title="It is already present in pending tab for changes" {% endif %}>
                                                    </button>
                                                </form>

                                                <form action="/Group_Management_module/GroupManagement/delete/{{ group.id }}" method="post">
                                                    <input type="hidden" name="username" value="{{ user }}">
                                                    <!-- Delete Button with tooltip if disabled -->
                                                    <button type="submit" class="btn btn-danger fas fa-trash-alt delete-group-btn"
                                                            {% if 'Pendingdeletion' in group.isid %} disabled title="It is already present in pending tab for changes" {% endif %}>
                                                    </button>
                                                </form>
                                            </div>


                                            </td>
                                        {% endif %}


                                    {% endif %}
                                </tr>
                            {% endfor %}

                </tbody>
            </table>

        </div>
    </div>
</div>
</div>
<!--<script src="{{ url_for('static', filename='/vendor/GroupManagement.js') }}"></script>-->
<script src="{{ url_for('static', filename='vendor/GroupManagement.js') }}"></script>

<script>
    var queryString = window.location.search;
    var urlParams = new URLSearchParams(queryString);
    if (urlParams.has('erromsg')) {
        var errorMsg = urlParams.get('erromsg');
        alert(errorMsg);
    }
    function getQueryParam(param) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(param);
    }
</script>
{% endblock %}

